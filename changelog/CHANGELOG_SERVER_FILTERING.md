# Changelog - Filtrage c√¥t√© serveur

## üìã R√©sum√© des modifications

Migration du filtrage des fichiers du c√¥t√© client vers le c√¥t√© serveur pour am√©liorer les performances et permettre le filtrage par description.

## üîß Probl√®me identifi√©

### **Sympt√¥mes :**
- ‚ö° **Performance d√©grad√©e** : Tous les fichiers charg√©s puis filtr√©s c√¥t√© client
- üîç **Filtrage limit√©** : Pas de filtrage par description
- üíæ **Consommation m√©moire** : Toutes les donn√©es transf√©r√©es m√™me si non utilis√©es
- üìä **Pagination inefficace** : Pagination apr√®s filtrage c√¥t√© client

### **Cause :**
Le filtrage se faisait c√¥t√© frontend apr√®s avoir charg√© tous les fichiers depuis le serveur.

## üõ†Ô∏è Solution appliqu√©e

### **1. Mod√®le File.js - Filtrage c√¥t√© serveur**

#### **findByUserPaginated() - Avec filtres :**
```javascript
static async findByUserPaginated(userId, page = 1, limit = 3, filters = {}) {
  return new Promise((resolve, reject) => {
    const offset = (page - 1) * limit;
    
    // Construire les conditions de filtrage
    let whereConditions = ['f.uploaded_by = ?'];
    let queryParams = [userId];
    
    // Filtre par nom de fichier ou description
    if (filters.searchTerm && filters.searchTerm.trim()) {
      whereConditions.push('(f.original_name LIKE ? OR f.description LIKE ?)');
      const searchPattern = `%${filters.searchTerm.trim()}%`;
      queryParams.push(searchPattern, searchPattern);
    }
    
    // Filtre par type de fichier
    if (filters.fileType && filters.fileType !== 'all') {
      whereConditions.push('f.file_type LIKE ?');
      queryParams.push(`%${filters.fileType}%`);
    }
    
    const whereClause = whereConditions.join(' AND ');
    
    // Requ√™te avec filtres et pagination
    const query = `
      SELECT f.*, u.name as uploaded_by_name, u.banque as uploaded_by_banque
      FROM files f
      LEFT JOIN users u ON f.uploaded_by = u.id
      WHERE ${whereClause}
      ORDER BY f.uploaded_at DESC
      LIMIT ? OFFSET ?
    `;
    
    // Retourne { files, pagination }
  });
}
```

#### **findAllPaginated() - Avec filtres avanc√©s :**
```javascript
static async findAllPaginated(page = 1, limit = 3, filters = {}) {
  return new Promise((resolve, reject) => {
    const offset = (page - 1) * limit;
    
    // Construire les conditions de filtrage
    let whereConditions = [];
    let queryParams = [];
    
    // Filtre par nom de fichier ou description
    if (filters.searchTerm && filters.searchTerm.trim()) {
      whereConditions.push('(f.original_name LIKE ? OR f.description LIKE ?)');
      const searchPattern = `%${filters.searchTerm.trim()}%`;
      queryParams.push(searchPattern, searchPattern);
    }
    
    // Filtre par type de fichier
    if (filters.fileType && filters.fileType !== 'all') {
      whereConditions.push('f.file_type LIKE ?');
      queryParams.push(`%${filters.fileType}%`);
    }
    
    // Filtre par banque (pour les admins/nsia_vie)
    if (filters.banque && filters.banque !== 'all') {
      whereConditions.push('f.deposant_banque = ?');
      queryParams.push(filters.banque);
    }
    
    const whereClause = whereConditions.length > 0 ? `WHERE ${whereConditions.join(' AND ')}` : '';
    
    // Requ√™te avec filtres et pagination
    const query = `
      SELECT f.*, u.name as uploaded_by_name, u.banque as uploaded_by_banque
      FROM files f
      LEFT JOIN users u ON f.uploaded_by = u.id
      ${whereClause}
      ORDER BY f.uploaded_at DESC
      LIMIT ? OFFSET ?
    `;
    
    // Retourne { files, pagination }
  });
}
```

### **2. Contr√¥leur userUploadController.js - Gestion des filtres**

#### **getUserDeposits() - Avec param√®tres de filtrage :**
```javascript
static async getUserDeposits(req, res) {
  try {
    // V√©rification du r√¥le 'user'
    if (req.user.role !== 'user') {
      return res.status(403).json({
        success: false,
        message: 'Acc√®s refus√©. Seuls les utilisateurs peuvent voir leurs d√©p√¥ts.'
      });
    }

    const userId = req.user.id;
    const page = parseInt(req.query.page) || 1;
    const limit = 3; // 3 √©l√©ments par page
    
    // R√©cup√©rer les filtres depuis les param√®tres de requ√™te
    const filters = {
      searchTerm: req.query.search || '',
      fileType: req.query.fileType || 'all'
    };
    
    const result = await File.findByUserPaginated(userId, page, limit, filters);
    
    res.json({
      success: true,
      deposits: result.files.map(file => ({
        // Mapping des donn√©es
      })),
      pagination: result.pagination
    });
  } catch (error) {
    // Gestion d'erreur
  }
}
```

#### **getAllDeposits() - Avec filtres avanc√©s :**
```javascript
static async getAllDeposits(req, res) {
  try {
    // V√©rification des droits admin/nsia_vie
    if (req.user.role !== 'admin' && req.user.role !== 'nsia_vie') {
      return res.status(403).json({
        success: false,
        message: 'Acc√®s refus√©. Droits insuffisants.'
      });
    }

    const page = parseInt(req.query.page) || 1;
    const limit = 3; // 3 √©l√©ments par page
    
    // R√©cup√©rer les filtres depuis les param√®tres de requ√™te
    const filters = {
      searchTerm: req.query.search || '',
      fileType: req.query.fileType || 'all',
      banque: req.query.banque || 'all'
    };
    
    const result = await File.findAllPaginated(page, limit, filters);
    
    res.json({
      success: true,
      deposits: result.files.map(file => ({
        // Mapping des donn√©es
      })),
      pagination: result.pagination
    });
  } catch (error) {
    // Gestion d'erreur
  }
}
```

### **3. Hook useUserFiles.ts - Gestion des filtres c√¥t√© frontend**

#### **√âtat des filtres :**
```typescript
const [filters, setFilters] = useState({
  searchTerm: '',
  fileType: 'all',
  banque: 'all'
});
```

#### **Construction des param√®tres de requ√™te :**
```typescript
const fetchUserFiles = async (page: number = 1) => {
  if (!currentUser) return;

  setIsLoading(true);
  setError(null);

  try {
    // Construire les param√®tres de requ√™te avec filtres
    const queryParams = new URLSearchParams({
      page: page.toString(),
      search: filters.searchTerm,
      fileType: filters.fileType
    });
    
    // Ajouter le filtre banque pour les admins/nsia_vie
    if (currentUser.role === 'admin' || currentUser.role === 'nsia_vie') {
      queryParams.append('banque', filters.banque);
    }
    
    let endpoint = '';
    if (currentUser.role === 'user') {
      endpoint = `http://localhost:5000/api/user-uploads/my-deposits?${queryParams.toString()}`;
    } else if (currentUser.role === 'admin' || currentUser.role === 'nsia_vie') {
      endpoint = `http://localhost:5000/api/user-uploads/all-deposits?${queryParams.toString()}`;
    }

    const response = await axios.get(endpoint, {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });

    if (response.data.success) {
      setFiles(response.data.deposits);
      setPagination(response.data.pagination);
    }
  } catch (error) {
    // Gestion d'erreur
  }
};
```

#### **Fonctions de gestion des filtres :**
```typescript
const updateFilters = (newFilters: Partial<typeof filters>) => {
  setFilters(prev => ({ ...prev, ...newFilters }));
};

const applyFilters = () => {
  fetchUserFiles(1); // Retourner √† la premi√®re page lors du filtrage
};
```

### **4. Composant FileList.tsx - Interface de filtrage**

#### **Gestionnaires d'√©v√©nements :**
```typescript
const handleSearchChange = (value: string) => {
  updateFilters({ searchTerm: value });
};

const handleFilterTypeChange = (value: string) => {
  updateFilters({ fileType: value });
};

const handleBanqueChange = (value: string) => {
  updateFilters({ banque: value });
};

const handleApplyFilters = () => {
  setCurrentPage(1); // Retourner √† la premi√®re page
  applyFilters();
};
```

#### **Interface de filtrage :**
```jsx
<div className="flex flex-col sm:flex-row gap-3">
  <div className="relative">
    <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-4 w-4" />
    <input
      type="text"
      placeholder="Rechercher un fichier ou une description..."
      value={filters.searchTerm}
      onChange={(e) => handleSearchChange(e.target.value)}
      className="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
    />
  </div>
  
  <div className="relative">
    <Filter className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-4 w-4" />
    <select
      value={filters.fileType}
      onChange={(e) => handleFilterTypeChange(e.target.value)}
      className="pl-10 pr-8 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
    >
      <option value="all">Tous les types</option>
      <option value="image">Images</option>
      <option value="pdf">PDF</option>
      <option value="excel">Excel</option>
      <option value="word">Word</option>
      <option value="video">Vid√©os</option>
      <option value="audio">Audio</option>
      <option value="sql">SQL</option>
      <option value="archive">Archives</option>
      <option value="code">Code</option>
    </select>
  </div>

  {/* Filtre par banque pour les admins/nsia_vie */}
  {(currentUser?.role === 'admin' || currentUser?.role === 'nsia_vie') && (
    <div className="relative">
      <select
        value={filters.banque}
        onChange={(e) => handleBanqueChange(e.target.value)}
        className="pl-4 pr-8 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
      >
        <option value="all">Toutes les banques</option>
        <option value="NSIA">NSIA</option>
        <option value="SGBCI">SGBCI</option>
        <option value="BACI">BACI</option>
        <option value="SIB">SIB</option>
        <option value="ECOBANK">ECOBANK</option>
      </select>
    </div>
  )}

  <button
    onClick={handleApplyFilters}
    disabled={isLoading}
    className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50"
  >
    Appliquer
  </button>
</div>
```

## üéØ Changements apport√©s

### **1. Backend - Mod√®le File.js**
- ‚úÖ **Filtrage c√¥t√© serveur** : Requ√™tes SQL avec conditions dynamiques
- ‚úÖ **Filtrage par description** : Recherche dans `original_name` ET `description`
- ‚úÖ **Filtrage par type** : Recherche par `file_type`
- ‚úÖ **Filtrage par banque** : Pour les admins/nsia_vie uniquement
- ‚úÖ **Pagination avec filtres** : Comptage total avec les m√™mes filtres

### **2. Backend - Contr√¥leur userUploadController.js**
- ‚úÖ **Param√®tres de filtrage** : R√©cup√©ration depuis `req.query`
- ‚úÖ **Validation des filtres** : Valeurs par d√©faut et validation
- ‚úÖ **Filtres sp√©cifiques** : Diff√©rents filtres selon le r√¥le utilisateur
- ‚úÖ **R√©ponse optimis√©e** : Seulement les donn√©es n√©cessaires

### **3. Frontend - Hook useUserFiles.ts**
- ‚úÖ **√âtat des filtres** : `useState` pour g√©rer les filtres
- ‚úÖ **Param√®tres de requ√™te** : Construction dynamique des URLs
- ‚úÖ **Fonctions de gestion** : `updateFilters()` et `applyFilters()`
- ‚úÖ **Retour √† la page 1** : Lors de l'application des filtres

### **4. Frontend - Composant FileList.tsx**
- ‚úÖ **Interface de filtrage** : Champs de recherche et s√©lecteurs
- ‚úÖ **Filtre par description** : Recherche dans le nom ET la description
- ‚úÖ **Filtre par banque** : Pour les admins/nsia_vie uniquement
- ‚úÖ **Bouton d'application** : Appliquer les filtres explicitement

## üîÑ Flux de filtrage

### **1. Saisie des filtres**
1. **Utilisateur saisit** ‚Üí Mise √† jour de l'√©tat `filters`
2. **Champs synchronis√©s** ‚Üí Affichage en temps r√©el
3. **Pas de requ√™te** ‚Üí Attente du clic sur "Appliquer"

### **2. Application des filtres**
1. **Clic sur "Appliquer"** ‚Üí `handleApplyFilters()`
2. **Retour page 1** ‚Üí `setCurrentPage(1)`
3. **Requ√™te API** ‚Üí `fetchUserFiles(1)` avec filtres
4. **R√©ponse serveur** ‚Üí Fichiers filtr√©s + pagination

### **3. Navigation avec filtres**
1. **Changement de page** ‚Üí `handlePageChange(page)`
2. **Requ√™te API** ‚Üí `fetchUserFiles(page)` avec filtres
3. **Mise √† jour** ‚Üí Nouveaux fichiers pour la page

## üìä Avantages du filtrage c√¥t√© serveur

### **1. Performance**
- üöÄ **Requ√™tes optimis√©es** : Seulement les donn√©es n√©cessaires
- ‚ö° **R√©ponse rapide** : Moins de donn√©es transf√©r√©es
- üíæ **√âconomie m√©moire** : Pas de surcharge c√¥t√© client

### **2. Fonctionnalit√©s**
- üîç **Filtrage par description** : Recherche dans le contenu
- üìä **Pagination pr√©cise** : Comptage avec filtres appliqu√©s
- üéØ **Filtres combin√©s** : Recherche + type + banque

### **3. Scalabilit√©**
- üìà **√âvolutif** : Fonctionne avec des milliers de fichiers
- üîß **Configurable** : Filtres facilement modifiables
- üõ°Ô∏è **S√©curis√©** : Validation c√¥t√© serveur

## üéÆ Comportement utilisateur

### **Sc√©nario 1 : Recherche simple**
- ‚úÖ **Saisie texte** ‚Üí Recherche dans nom ET description
- ‚úÖ **Application** ‚Üí R√©sultats filtr√©s c√¥t√© serveur
- ‚úÖ **Pagination** ‚Üí Navigation dans les r√©sultats filtr√©s

### **Sc√©nario 2 : Filtrage par type**
- ‚úÖ **S√©lection type** ‚Üí Filtrage par type de fichier
- ‚úÖ **Combinaison** ‚Üí Recherche + type simultan√©ment
- ‚úÖ **R√©sultats** ‚Üí Fichiers correspondant aux crit√®res

### **Sc√©nario 3 : Filtrage par banque (admin)**
- ‚úÖ **S√©lection banque** ‚Üí Filtrage par banque d√©posante
- ‚úÖ **Filtres multiples** ‚Üí Recherche + type + banque
- ‚úÖ **R√©sultats pr√©cis** ‚Üí Fichiers exactement correspondants

## üöÄ D√©ploiement

### **1. Red√©marrage du serveur**
```bash
# Dans le dossier backend
npm restart
```

### **2. Test de la fonctionnalit√©**
- **Test 1** : Recherche par nom ‚Üí ‚úÖ Filtrage c√¥t√© serveur
- **Test 2** : Recherche par description ‚Üí ‚úÖ Nouveau fonctionnalit√©
- **Test 3** : Filtrage par type ‚Üí ‚úÖ Combinaison possible
- **Test 4** : Filtrage par banque ‚Üí ‚úÖ Admin/nsia_vie uniquement

### **3. V√©rification des performances**
- **Requ√™tes API** : Seulement les donn√©es filtr√©es
- **Temps de r√©ponse** : Am√©lioration significative
- **M√©moire client** : R√©duction de l'utilisation

## üìù Notes importantes

### **Filtres disponibles**
- **Recherche** : Nom de fichier ET description
- **Type** : Images, PDF, Excel, Word, Vid√©os, Audio, SQL, Archives, Code
- **Banque** : NSIA, SGBCI, BACI, SIB, ECOBANK (admin/nsia_vie uniquement)

### **Performance**
- **Requ√™tes optimis√©es** : `LIKE` avec index sur les colonnes
- **Pagination** : `LIMIT` et `OFFSET` avec filtres
- **Cache** : Pas de mise en cache (donn√©es dynamiques)

### **S√©curit√©**
- **Validation** : Param√®tres de filtrage valid√©s
- **Autorisation** : Filtres selon le r√¥le utilisateur
- **Injection SQL** : Param√®tres pr√©par√©s

Le filtrage c√¥t√© serveur est maintenant actif avec recherche par description ! üéØ
